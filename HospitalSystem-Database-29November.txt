-- ==========================================================
-- Hospital Management System Database Schema
-- 3NF Compliant with proper relationships
-- ==========================================================

-- 1. Users Table (Unified authentication)
CREATE TABLE users (
    user_id NUMBER PRIMARY KEY,
    email VARCHAR2(100) UNIQUE NOT NULL,
    password VARCHAR2(255) NOT NULL,
    user_type VARCHAR2(20) NOT NULL CHECK (user_type IN ('admin', 'doctor', 'patient')),
    is_active NUMBER(1) DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 2. Departments Table
CREATE TABLE departments (
    department_id NUMBER PRIMARY KEY,
    name VARCHAR2(100) NOT NULL,
    head_doctor_id NUMBER,
    floor NUMBER,
    max_capacity NUMBER DEFAULT 10,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 3. Doctors Table
CREATE TABLE doctors (
    doctor_id NUMBER PRIMARY KEY,
    user_id NUMBER NOT NULL,
    department_id NUMBER NOT NULL,
    name VARCHAR2(100) NOT NULL,
    specialization VARCHAR2(100) NOT NULL,
    license_number VARCHAR2(50) UNIQUE NOT NULL,
    phone VARCHAR2(20),
    experience_years NUMBER,
    consultation_fee NUMBER(10,2) NOT NULL,
    status VARCHAR2(20) DEFAULT 'Active' CHECK (status IN ('Active', 'On Leave')),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(user_id),
    FOREIGN KEY (department_id) REFERENCES departments(department_id)
);

-- 4. Patients Table
CREATE TABLE patients (
    patient_id NUMBER PRIMARY KEY,
    user_id NUMBER NOT NULL,
    name VARCHAR2(100) NOT NULL,
    date_of_birth DATE NOT NULL,
    gender VARCHAR2(10) CHECK (gender IN ('Male', 'Female', 'Other')),
    blood_type VARCHAR2(5),
    phone VARCHAR2(20),
    address VARCHAR2(255),
    emergency_contact VARCHAR2(100),
    medical_history CLOB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(user_id)
);

-- 5. Appointments Table
CREATE TABLE appointments (
    appointment_id NUMBER PRIMARY KEY,
    patient_id NUMBER NOT NULL,
    doctor_id NUMBER NOT NULL,
    appointment_date DATE NOT NULL,
    appointment_time VARCHAR2(10) NOT NULL,
    reason VARCHAR2(500),
    status VARCHAR2(20) DEFAULT 'Scheduled' CHECK (status IN ('Scheduled', 'Completed', 'Cancelled', 'No Show')),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (patient_id) REFERENCES patients(patient_id),
    FOREIGN KEY (doctor_id) REFERENCES doctors(doctor_id)
);

-- 6. Bills Table
CREATE TABLE bills (
    bill_id NUMBER PRIMARY KEY,
    appointment_id NUMBER NOT NULL,
    amount NUMBER(10,2) NOT NULL,
    payment_status VARCHAR2(20) DEFAULT 'Unpaid' CHECK (payment_status IN ('Paid', 'Unpaid')),
    generated_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    paid_date TIMESTAMP,
    FOREIGN KEY (appointment_id) REFERENCES appointments(appointment_id)
);

-- 7. Prescriptions Table
CREATE TABLE prescriptions (
    prescription_id NUMBER PRIMARY KEY,
    appointment_id NUMBER NOT NULL,
    diagnosis CLOB,
    notes CLOB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (appointment_id) REFERENCES appointments(appointment_id)
);

-- 8. Prescription_Medicines Table
CREATE TABLE prescription_medicines (
    medicine_id NUMBER PRIMARY KEY,
    prescription_id NUMBER NOT NULL,
    medicine_name VARCHAR2(100) NOT NULL,
    dosage VARCHAR2(100) NOT NULL,
    duration VARCHAR2(100) NOT NULL,
    instructions VARCHAR2(500),
    FOREIGN KEY (prescription_id) REFERENCES prescriptions(prescription_id) ON DELETE CASCADE
);

-- Create Sequences
CREATE SEQUENCE seq_users START WITH 1001 INCREMENT BY 1;
CREATE SEQUENCE seq_departments START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE seq_doctors START WITH 101 INCREMENT BY 1;
CREATE SEQUENCE seq_patients START WITH 10001 INCREMENT BY 1;
CREATE SEQUENCE seq_appointments START WITH 100001 INCREMENT BY 1;
CREATE SEQUENCE seq_bills START WITH 1000001 INCREMENT BY 1;
CREATE SEQUENCE seq_prescriptions START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE seq_medicines START WITH 1 INCREMENT BY 1;


-- ==========================================================
-- TRIGGERS
-- ==========================================================

-- 1. Trigger: Prevent double booking for doctors
CREATE OR REPLACE TRIGGER trg_prevent_double_booking
BEFORE INSERT ON appointments
FOR EACH ROW
DECLARE
    v_count NUMBER;
BEGIN
    SELECT COUNT(*) INTO v_count
    FROM appointments
    WHERE doctor_id = :NEW.doctor_id
    AND appointment_date = :NEW.appointment_date
    AND appointment_time = :NEW.appointment_time
    AND status != 'Cancelled';
    
    IF v_count > 0 THEN
        RAISE_APPLICATION_ERROR(-20001, 'Doctor already has an appointment at this time');
    END IF;
END;
/

-- 2. Trigger: Auto-generate bill when appointment is completed
CREATE OR REPLACE TRIGGER trg_auto_generate_bill
AFTER UPDATE ON appointments
FOR EACH ROW
WHEN (OLD.status != 'Completed' AND NEW.status = 'Completed')
DECLARE
    v_consultation_fee NUMBER;
BEGIN
    SELECT consultation_fee INTO v_consultation_fee
    FROM doctors
    WHERE doctor_id = :NEW.doctor_id;
    
    INSERT INTO bills (bill_id, appointment_id, amount, payment_status)
    VALUES (seq_bills.NEXTVAL, :NEW.appointment_id, v_consultation_fee, 'Unpaid');
    
    DBMS_OUTPUT.PUT_LINE('Bill generated for appointment ' || :NEW.appointment_id);
END;
/

-- 3. Trigger: Enforce department capacity
CREATE OR REPLACE TRIGGER trg_department_capacity
BEFORE INSERT OR UPDATE ON doctors
FOR EACH ROW
DECLARE
    v_current_count NUMBER;
    v_max_capacity NUMBER;
BEGIN
    SELECT COUNT(*), max_capacity 
    INTO v_current_count, v_max_capacity
    FROM doctors d
    JOIN departments dept ON d.department_id = dept.department_id
    WHERE d.department_id = :NEW.department_id
    AND d.status = 'Active';
    
    IF v_current_count >= v_max_capacity THEN
        RAISE_APPLICATION_ERROR(-20002, 'Department has reached maximum capacity of ' || v_max_capacity || ' doctors');
    END IF;
END;
/

-- 4. Trigger: Prevent prescription for incomplete appointments
CREATE OR REPLACE TRIGGER trg_prescription_appointment_check
BEFORE INSERT ON prescriptions
FOR EACH ROW
DECLARE
    v_appointment_status VARCHAR2(20);
BEGIN
    SELECT status INTO v_appointment_status
    FROM appointments
    WHERE appointment_id = :NEW.appointment_id;
    
    IF v_appointment_status != 'Completed' THEN
        RAISE_APPLICATION_ERROR(-20003, 'Prescriptions can only be created for completed appointments');
    END IF;
END;
/

-- ==========================================================
-- STORED PROCEDURES
-- ==========================================================

-- 1. Procedure: Complete appointment and create prescription
CREATE OR REPLACE PROCEDURE complete_appointment(
    p_appointment_id IN NUMBER,
    p_diagnosis IN CLOB,
    p_notes IN CLOB
)
AS
    v_appointment_count NUMBER;
BEGIN
    -- Check if appointment exists and is scheduled
    SELECT COUNT(*) INTO v_appointment_count
    FROM appointments
    WHERE appointment_id = p_appointment_id AND status = 'Scheduled';
    
    IF v_appointment_count = 0 THEN
        RAISE_APPLICATION_ERROR(-20004, 'Appointment not found or not scheduled');
    END IF;
    
    -- Update appointment status
    UPDATE appointments 
    SET status = 'Completed' 
    WHERE appointment_id = p_appointment_id;
    
    -- Create prescription
    INSERT INTO prescriptions (prescription_id, appointment_id, diagnosis, notes)
    VALUES (seq_prescriptions.NEXTVAL, p_appointment_id, p_diagnosis, p_notes);
    
    COMMIT;
END;
/

-- 2. Procedure: Get doctor availability
CREATE OR REPLACE PROCEDURE get_doctor_availability(
    p_doctor_id IN NUMBER,
    p_date IN DATE,
    p_available_slots OUT SYS_REFCURSOR
)
AS
BEGIN
    OPEN p_available_slots FOR
    SELECT time_slot
    FROM (
        SELECT '09:00 AM' as time_slot FROM DUAL UNION
        SELECT '09:30 AM' FROM DUAL UNION
        SELECT '10:00 AM' FROM DUAL UNION
        SELECT '10:30 AM' FROM DUAL UNION
        SELECT '11:00 AM' FROM DUAL UNION
        SELECT '11:30 AM' FROM DUAL UNION
        SELECT '02:00 PM' FROM DUAL UNION
        SELECT '02:30 PM' FROM DUAL UNION
        SELECT '03:00 PM' FROM DUAL UNION
        SELECT '03:30 PM' FROM DUAL UNION
        SELECT '04:00 PM' FROM DUAL UNION
        SELECT '04:30 PM' FROM DUAL
    ) all_slots
    WHERE time_slot NOT IN (
        SELECT appointment_time
        FROM appointments
        WHERE doctor_id = p_doctor_id
        AND appointment_date = p_date
        AND status != 'Cancelled'
    );
END;
/

-- 3. Function: Calculate department statistics
CREATE OR REPLACE FUNCTION get_department_stats(
    p_department_id IN NUMBER
) RETURN SYS_REFCURSOR
AS
    v_stats SYS_REFCURSOR;
BEGIN
    OPEN v_stats FOR
    SELECT 
        d.name as department_name,
        COUNT(DISTINCT doc.doctor_id) as doctor_count,
        COUNT(DISTINCT p.patient_id) as patient_count,
        COUNT(a.appointment_id) as appointment_count,
        SUM(CASE WHEN b.payment_status = 'Paid' THEN b.amount ELSE 0 END) as total_revenue
    FROM departments d
    LEFT JOIN doctors doc ON d.department_id = doc.department_id
    LEFT JOIN appointments a ON doc.doctor_id = a.doctor_id
    LEFT JOIN patients p ON a.patient_id = p.patient_id
    LEFT JOIN bills b ON a.appointment_id = b.appointment_id
    WHERE d.department_id = p_department_id
    GROUP BY d.name;
    
    RETURN v_stats;
END;
/


-- ==========================================================
-- SAMPLE DATA
-- ==========================================================

-- Insert Users
INSERT INTO users (user_id, email, password, user_type) VALUES (seq_users.NEXTVAL, 'admin@hospital.com', 'admin123', 'admin');
INSERT INTO users (user_id, email, password, user_type) VALUES (seq_users.NEXTVAL, 'sarah.johnson', 'doctor123', 'doctor');
INSERT INTO users (user_id, email, password, user_type) VALUES (seq_users.NEXTVAL, 'michael.chen', 'doctor123', 'doctor');
INSERT INTO users (user_id, email, password, user_type) VALUES (seq_users.NEXTVAL, 'john.doe', 'patient123', 'patient');
INSERT INTO users (user_id, email, password, user_type) VALUES (seq_users.NEXTVAL, 'mary.johnson', 'patient123', 'patient');

-- Insert Departments
INSERT INTO departments (department_id, name, floor, max_capacity) VALUES (seq_departments.NEXTVAL, 'Cardiology', 3, 8);
INSERT INTO departments (department_id, name, floor, max_capacity) VALUES (seq_departments.NEXTVAL, 'Neurology', 4, 6);
INSERT INTO departments (department_id, name, floor, max_capacity) VALUES (seq_departments.NEXTVAL, 'Pediatrics', 2, 10);
INSERT INTO departments (department_id, name, floor, max_capacity) VALUES (seq_departments.NEXTVAL, 'Orthopedics', 5, 7);
INSERT INTO departments (department_id, name, floor, max_capacity) VALUES (seq_departments.NEXTVAL, 'Emergency', 1, 12);

-- Insert Doctors
INSERT INTO doctors (doctor_id, user_id, department_id, name, specialization, license_number, phone, experience_years, consultation_fee) 
VALUES (seq_doctors.NEXTVAL, 1002, 1, 'Dr. Sarah Johnson', 'Cardiologist', 'CARD12345', '555-0101', 15, 200.00);

INSERT INTO doctors (doctor_id, user_id, department_id, name, specialization, license_number, phone, experience_years, consultation_fee) 
VALUES (seq_doctors.NEXTVAL, 1003, 2, 'Dr. Michael Chen', 'Neurologist', 'NEURO67890', '555-0102', 12, 180.00);

-- Insert Patients
INSERT INTO patients (patient_id, user_id, name, date_of_birth, gender, blood_type, phone, address, emergency_contact) 
VALUES (seq_patients.NEXTVAL, 1004, 'John Doe', DATE '1990-05-15', 'Male', 'O+', '555-0123', '123 Main St, City', 'Jane Doe - 555-0124');

INSERT INTO patients (patient_id, user_id, name, date_of_birth, gender, blood_type, phone, address, emergency_contact) 
VALUES (seq_patients.NEXTVAL, 1005, 'Mary Johnson', DATE '1985-08-22', 'Female', 'A+', '555-0125', '456 Oak St, City', 'Robert Johnson - 555-0126');

COMMIT;


-- Disable the problematic trigger temporarily
ALTER TRIGGER trg_department_capacity DISABLE;

-- Now insert the doctors
INSERT INTO doctors (doctor_id, user_id, department_id, name, specialization, license_number, phone, experience_years, consultation_fee, status)
VALUES (101, 1002, 1, 'Dr. Sarah Johnson', 'Cardiologist', 'CARD12345', '555-0101', 15, 200.00, 'Active');

INSERT INTO doctors (doctor_id, user_id, department_id, name, specialization, license_number, phone, experience_years, consultation_fee, status)
VALUES (102, 1003, 2, 'Dr. Michael Chen', 'Neurologist', 'NEURO67890', '555-0102', 12, 180.00, 'Active');

INSERT INTO doctors (doctor_id, user_id, department_id, name, specialization, license_number, phone, experience_years, consultation_fee, status)
VALUES (103, 1001, 3, 'Dr. Emily Davis', 'Pediatrician', 'PED12346', '555-0103', 8, 150.00, 'Active');

INSERT INTO doctors (doctor_id, user_id, department_id, name, specialization, license_number, phone, experience_years, consultation_fee, status)
VALUES (104, 1001, 4, 'Dr. Robert Wilson', 'Orthopedic Surgeon', 'ORTHO12347', '555-0104', 20, 250.00, 'Active');

COMMIT;

-- Drop the broken trigger
DROP TRIGGER trg_department_capacity;

-- Create a fixed version
CREATE OR REPLACE TRIGGER trg_department_capacity
BEFORE INSERT OR UPDATE ON doctors
FOR EACH ROW
DECLARE
    v_current_count NUMBER;
    v_max_capacity NUMBER;
BEGIN
    -- Get current doctor count and max capacity for the department
    SELECT COUNT(*), NVL(MAX(max_capacity), 10)
    INTO v_current_count, v_max_capacity
    FROM doctors d
    JOIN departments dept ON d.department_id = dept.department_id
    WHERE d.department_id = :NEW.department_id
    AND d.status = 'Active'
    GROUP BY dept.department_id, dept.max_capacity;
    
    IF v_current_count >= v_max_capacity THEN
        RAISE_APPLICATION_ERROR(-20002, 'Department has reached maximum capacity of ' || v_max_capacity || ' doctors');
    END IF;
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        -- Department doesn't exist or has no doctors yet, allow insertion
        NULL;
END;
/

-- Add appointments
INSERT INTO appointments (appointment_id, patient_id, doctor_id, appointment_date, appointment_time, reason, status)
VALUES (100001, 10001, 101, DATE '2025-11-25', '10:00 AM', 'Heart palpitations', 'Scheduled');

INSERT INTO appointments (appointment_id, patient_id, doctor_id, appointment_date, appointment_time, reason, status)
VALUES (100002, 10002, 102, DATE '2025-11-26', '02:30 PM', 'Migraine consultation', 'Scheduled');

INSERT INTO appointments (appointment_id, patient_id, doctor_id, appointment_date, appointment_time, reason, status)
VALUES (100003, 10001, 103, DATE '2025-11-27', '11:00 AM', 'Child vaccination', 'Completed');

INSERT INTO appointments (appointment_id, patient_id, doctor_id, appointment_date, appointment_time, reason, status)
VALUES (100004, 10002, 104, DATE '2025-11-28', '03:00 PM', 'Knee pain evaluation', 'Scheduled');

COMMIT;

